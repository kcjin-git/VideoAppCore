
@page "/auth/login"

@using VideoAppCore.Data.Models

@inject IUserAsync userSvc
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

@inject NavigationManager NavigationManager


<EditForm Model="@user" OnSubmit="@Save">

    <div class="wrap-input100 validate-input m-b-26" data-validate="e-mail is required">
        <span class="label-input100">E-Mail</span>
        <InputText class="input100" type="text" name="email" @bind-Value="@user.EMAIL" placeholder="Enter e-mail" />
        <span class="focus-input100"></span>
    </div>

    <div class="wrap-input100 validate-input m-b-26" data-validate="password is required">
        <span class="label-input100">Password</span>
        <InputText class="input100" type="password" name="password" @bind-Value="@user.PASSWORD" placeholder="Enter password" />
        <span class="focus-input100"></span>
    </div>


    <button type="submit">Login</button>

</EditForm>




@code {

    User user = new User();

    protected async Task OnBtnClick()
    {
        /*
        user.CREATOR = "null";

        user.ORGN_NAME = "고객DX솔루션팀";
        user.PART_NAME = "AntBot";
        user.USER_NAME = "진광철";

            */

        user = await userSvc.AddUserAsync(user);

        user = await userSvc.GetUserByIdAsync(user.USER_ID);

    }

    public async Task Save()
    {
        User userInfo = new User();
        userInfo = await userSvc.LogIn(user.EMAIL, user.PASSWORD);


        if (userInfo == null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "login failed");
        }
        else
        {
            ((SiteAuthenticationStateProvider)AuthenticationStateProvider).SetAuthenticationStateAsync(userInfo.EMAIL, userInfo.USER_NAME, userInfo.ORGN_NAME);


            await sessionStorage.SetItemAsync("UserName", userInfo.USER_NAME);
            await sessionStorage.SetItemAsync("EMailAddr", userInfo.EMAIL);
            await sessionStorage.SetItemAsync("OrgnName", userInfo.ORGN_NAME);

            //var name = await sessionStorage.GetItemAsync<string>("name");


            await JSRuntime.InvokeVoidAsync("alert", "login succeed");

            NavigationManager.NavigateTo("/");
        }

    }

}
